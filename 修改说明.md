# 图表视图功能实现说明

## 概述

本文档详细说明了为 Focalboard 项目添加任务管理可视化图表功能的实现过程。该功能允许用户创建图表视图，以柱状图、折线图或饼图的形式可视化任务数据。

## 功能特性

- ✅ 支持三种图表类型：柱状图、折线图、饼图
- ✅ 自动数据分组：可按分组属性显示，或自动按选择属性分组
- ✅ 响应式设计：图表自适应容器大小
- ✅ 交互式图表：支持工具提示和图例
- ✅ 多语言支持：支持英文和中文界面

## 文件修改清单

### 1. 核心类型定义文件

#### `webapp/src/blocks/boardView.ts`
- **修改类型**：类型定义扩展
- **修改位置**：第 7 行
- **修改内容**：在 `IViewType` 类型中添加 `'chart'` 视图类型

```typescript
type IViewType = 'board' | 'table' | 'gallery' | 'calendar' | 'chart'
```

**说明**：扩展视图类型定义，使系统能够识别和处理图表视图类型。

---

### 2. 新建图表图标组件

#### `webapp/src/widgets/icons/chart.tsx`（新建文件）
- **文件类型**：React 组件
- **功能**：创建图表图标 SVG 组件
- **用途**：用于视图菜单和侧边栏显示图表视图图标

**主要代码结构**：
```typescript
export default function ChartIcon(): JSX.Element {
    return (
        <svg width='24' height='24' viewBox='0 0 24 24' ...>
            {/* SVG 路径定义 */}
        </svg>
    )
}
```

#### `webapp/src/widgets/icons/chart.scss`（新建文件）
- **文件类型**：样式文件
- **功能**：定义图表图标的样式
- **样式内容**：设置图标尺寸为 18x18 像素

---

### 3. 新建图表视图组件

#### `webapp/src/components/chart/chartView.tsx`（新建文件）
- **文件类型**：React 组件
- **功能**：图表视图主组件，提供数据可视化功能

**主要功能**：
1. **图表类型切换**：支持柱状图、折线图、饼图三种类型
2. **数据分组**：
   - 优先使用分组属性（groupByProperty）的数据
   - 如果没有分组属性，自动按第一个选择属性分组
   - 如果都没有，显示总任务数
3. **图表渲染**：使用 recharts 库渲染交互式图表
4. **空数据处理**：当没有数据时显示友好提示

**关键代码片段**：
```typescript
const chartData = useMemo(() => {
    // 如果有分组属性，使用分组数据
    if (props.groupByProperty && visibleGroups && visibleGroups.length > 0) {
        return visibleGroups.map((group) => ({
            name: group.option.value || '未分组',
            value: group.cards.length,
            color: group.option.color || COLORS[0],
        }))
    }
    // 自动分组逻辑...
}, [visibleGroups, props.groupByProperty, board.cardProperties, cards])
```

#### `webapp/src/components/chart/chartView.scss`（新建文件）
- **文件类型**：样式文件
- **功能**：定义图表视图的样式
- **样式内容**：
  - 图表头部布局
  - 图表类型选择器按钮样式
  - 图表容器样式
  - 空数据提示样式

---

### 4. 视图菜单集成

#### `webapp/src/components/viewMenu.tsx`
- **修改类型**：功能扩展
- **修改位置**：多处

**修改内容**：

1. **导入图表图标**（第 20 行）
```typescript
import ChartIcon from '../widgets/icons/chart'
```

2. **添加创建图表视图的处理函数**（第 211-235 行）
```typescript
const handleAddViewChart = useCallback(() => {
    const {board, activeView, intl} = props
    // 创建新的图表视图
    const view = createBoardView()
    view.title = intl.formatMessage({id: 'View.NewChartTitle', defaultMessage: 'Chart view'})
    view.fields.viewType = 'chart'
    // ...
}, [props.board, props.activeView, props.intl, showView])
```

3. **更新图标映射函数**（第 240-248 行）
```typescript
const iconForViewType = (viewType: IViewType) => {
    switch (viewType) {
    case 'board': return <BoardIcon/>
    case 'table': return <TableIcon/>
    case 'gallery': return <GalleryIcon/>
    case 'calendar': return <CalendarIcon/>
    case 'chart': return <ChartIcon/>  // 新增
    default: return <div/>
    }
}
```

4. **在添加视图子菜单中添加图表选项**（第 317-321 行）
```typescript
<Menu.Text
    id='chart'
    name={chartText}
    icon={<ChartIcon/>}
    onClick={handleAddViewChart}
/>
```

**说明**：用户可以通过视图菜单中的"添加视图" → "图表"选项创建新的图表视图。

---

### 5. 中心面板集成

#### `webapp/src/components/centerPanel.tsx`
- **修改类型**：功能扩展
- **修改位置**：第 60 行（导入）、第 513-520 行（渲染逻辑）

**修改内容**：

1. **导入图表组件**（第 60 行）
```typescript
import ChartView from './chart/chartView'
```

2. **添加图表视图的渲染逻辑**（第 513-520 行）
```typescript
{activeView.fields.viewType === 'chart' &&
    <ChartView
        board={props.board}
        cards={props.cards}
        activeView={props.activeView}
        readonly={props.readonly}
        groupByProperty={props.groupByProperty}
        visibleGroups={visibleGroups}
    />}
```

**说明**：根据当前视图类型，在中心面板中渲染对应的图表组件。

---

### 6. 侧边栏集成

#### `webapp/src/components/sidebar/sidebarBoardItem.tsx`
- **修改类型**：功能扩展
- **修改位置**：第 29 行（导入）、第 44-52 行（图标函数）

**修改内容**：

1. **导入图表图标**（第 29 行）
```typescript
import ChartIcon from '../../widgets/icons/chart'
```

2. **更新图标映射函数**（第 44-52 行）
```typescript
const iconForViewType = (viewType: IViewType): JSX.Element => {
    switch (viewType) {
    case 'board': return <BoardIcon/>
    case 'table': return <TableIcon/>
    case 'gallery': return <GalleryIcon/>
    case 'calendar': return <CalendarIcon/>
    case 'chart': return <ChartIcon/>  // 新增
    default: return <div/>
    }
}
```

**说明**：确保侧边栏中正确显示图表视图的图标。

---

### 7. 视图头部支持

#### `webapp/src/components/viewHeader/viewHeader.tsx`
- **修改类型**：功能扩展
- **修改位置**：第 70 行

**修改内容**：
```typescript
const withGroupBy = activeView.fields.viewType === 'board' || 
                   activeView.fields.viewType === 'table' || 
                   activeView.fields.viewType === 'chart'  // 新增
```

**说明**：使图表视图支持分组功能，用户可以在图表视图中按属性分组显示数据。

---

### 8. 工作区支持

#### `webapp/src/components/workspace.tsx`
- **修改类型**：功能扩展
- **修改位置**：第 122 行

**修改内容**：
```typescript
if ((!property || !propsRegistry.get(property.type).canGroup) && 
    (activeView.fields.viewType === 'board' || 
     activeView.fields.viewType === 'chart')) {  // 新增 chart
    property = board?.cardProperties.find((o) => propsRegistry.get(o.type).canGroup)
}
```

**说明**：当图表视图没有设置分组属性时，自动选择第一个可分组属性作为默认分组属性。

---

### 9. 国际化文件

#### `webapp/i18n/en.json`
- **修改类型**：添加国际化文本
- **修改位置**：第 321 行、第 326 行、文件末尾

**添加的文本**：
```json
"View.Chart": "Chart",
"View.NewChartTitle": "Chart view",
"ChartView.title": "Task Statistics Chart",
"ChartView.bar": "Bar Chart",
"ChartView.line": "Line Chart",
"ChartView.pie": "Pie Chart",
"ChartView.noData": "No data to display"
```

#### `webapp/i18n/zh_Hans.json`
- **修改类型**：添加国际化文本
- **修改位置**：第 313 行、第 317 行、文件末尾

**添加的文本**：
```json
"View.Chart": "图表",
"View.NewChartTitle": "图表视图",
"ChartView.title": "任务统计图表",
"ChartView.bar": "柱状图",
"ChartView.line": "折线图",
"ChartView.pie": "饼图",
"ChartView.noData": "暂无数据可显示"
```

**说明**：提供英文和中文的界面文本支持，确保多语言环境下的正常显示。

---

### 10. 依赖包更新

#### `webapp/package.json`
- **修改类型**：添加依赖
- **修改方式**：通过命令行 `npm install recharts --save` 添加

**新增依赖**：
```json
"recharts": "^2.x.x"
```

**说明**：recharts 是一个基于 React 和 D3 的图表库，提供了丰富的图表组件，包括柱状图、折线图、饼图等。

---

## 使用说明

### 创建图表视图

1. 在视图菜单中点击"添加视图"（Add view）
2. 选择"图表"（Chart）选项
3. 系统会自动创建新的图表视图

### 使用图表视图

1. **切换图表类型**：点击图表上方的按钮切换柱状图、折线图或饼图
2. **设置分组**：在视图头部使用"分组"功能，按属性分组显示数据
3. **查看数据**：鼠标悬停在图表上可查看详细数据

### 数据分组逻辑

- **有分组属性**：按设置的分组属性显示各组任务数量
- **无分组属性**：自动按第一个选择属性分组
- **无选择属性**：显示总任务数

---

## 技术实现细节

### 图表库选择

选择 **recharts** 作为图表库的原因：
- 专为 React 设计，与项目技术栈匹配
- 提供丰富的图表类型
- 支持响应式设计
- 良好的文档和社区支持
- 性能优秀，适合实时数据更新

### 数据流

```
Cards (卡片数据)
  ↓
getVisibleAndHiddenGroups (分组处理)
  ↓
ChartView (图表组件)
  ↓
useMemo (数据转换)
  ↓
Recharts Components (图表渲染)
```

### 组件结构

```
ChartView (主组件)
├── chart-header (头部)
│   ├── chart-title (标题)
│   └── chart-type-selector (类型选择器)
└── chart-container (图表容器)
    ├── BarChart (柱状图)
    ├── LineChart (折线图)
    └── PieChart (饼图)
```

---

## 修改统计

- **新建文件**：4 个
  - `webapp/src/widgets/icons/chart.tsx`
  - `webapp/src/widgets/icons/chart.scss`
  - `webapp/src/components/chart/chartView.tsx`
  - `webapp/src/components/chart/chartView.scss`

- **修改文件**：8 个
  - `webapp/src/blocks/boardView.ts`
  - `webapp/src/components/viewMenu.tsx`
  - `webapp/src/components/centerPanel.tsx`
  - `webapp/src/components/sidebar/sidebarBoardItem.tsx`
  - `webapp/src/components/viewHeader/viewHeader.tsx`
  - `webapp/src/components/workspace.tsx`
  - `webapp/i18n/en.json`
  - `webapp/i18n/zh_Hans.json`

- **新增依赖**：1 个
  - `recharts`

---

## 测试建议

### 功能测试

1. ✅ 创建图表视图
2. ✅ 切换图表类型（柱状图、折线图、饼图）
3. ✅ 测试分组功能
4. ✅ 测试无数据情况
5. ✅ 测试多语言切换

### 边界情况

1. 空看板（无卡片）
2. 无分组属性
3. 大量数据性能测试
4. 响应式布局测试

---

## 后续优化建议

1. **更多图表类型**：添加面积图、散点图等
2. **自定义配置**：允许用户自定义图表颜色、标签等
3. **数据筛选**：在图表视图中支持筛选功能
4. **导出功能**：支持将图表导出为图片
5. **时间序列图表**：支持按时间维度显示数据趋势
6. **多维度分析**：支持多个属性的组合分析




